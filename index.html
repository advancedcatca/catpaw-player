<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>çŒ«jio Player</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/6.6.3/wavesurfer.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    body{font-family:'Arial',sans-serif;max-width:800px;margin:0 auto;padding:20px;background:#f8f9fa;}
    h1{color:#333;text-align:center;margin:0 0 16px;}
    .container{background:#fff;border-radius:12px;padding:20px;box-shadow:0 5px 15px rgba(0,0,0,.1);}
    .local-file-section{margin-bottom:20px;padding-bottom:16px;border-bottom:2px dotted #eee;}
    .tip-box{background:#fff8dc;border:1px solid #f0e68c;border-radius:6px;padding:10px 12px;margin-bottom:12px;color:#8b4513;font-size:14px;}
    .message-box{display:none;margin:8px 0;padding:8px 10px;border-radius:6px;font-size:14px;text-align:center}
    .success-message{display:block;background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .error-message{display:block;background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .add-button{background:#27ae60;color:#fff;border:none;border-radius:6px;padding:10px 14px;font-weight:700;cursor:pointer}
    .small-button{font-size:14px;padding:6px 10px;border-radius:4px}
    #audioFiles{display:none}
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:center;margin-top:10px}

    /* æ’­æ”¾åˆ—è¡¨ï¼šå•ä¸ªåˆ—è¡¨æ¡† */
    .playlist-box{border:1px solid #e1e4e8;border-radius:10px;padding:8px;max-height:300px;overflow:auto;background:#fafafa}
    .playlist-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:6px;cursor:pointer;font-weight:500;color:#444}
    .playlist-item:hover{background:#eef6ff}
    .playlist-item.active{background:#e3f2fd;border:1px solid #2196f3}
    .playlist-item.selected{outline:2px solid #a3c5ff;background:#f0f8ff}
    .playlist-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* æ­£åœ¨æ’­æ”¾æŒ‡ç¤ºç‚¹ */
    .np{width:10px;height:10px;border-radius:50%;background:#4a6fa5;opacity:0;flex:0 0 auto}
    .playlist-item.active .np{opacity:1;animation:pulse 1.2s infinite ease-in-out}
    @keyframes pulse{
      0%{transform:scale(.9);opacity:.6}
      50%{transform:scale(1.2);opacity:1}
      100%{transform:scale(.9);opacity:.6}
    }

    /* æ’­æ”¾å™¨ */
    .current-player{margin-top:18px;border:1px solid #e1e4e8;border-radius:10px;padding:16px;background:#fff;box-shadow:0 3px 10px rgba(0,0,0,.05);position:relative}
    .current-title{font-weight:700;color:#2c3e50;margin-bottom:10px}
    .waveform-container{margin-top:8px;border:1px solid #e1e4e8;border-radius:8px;padding:12px;background:#f9f9f9}
    #waveform{height:100px}
    .time-display{font-family:monospace;text-align:center;margin:8px 0;color:#666}

    /* ä¸»æ§æŒ‰é’®ï¼šä¸ç®€æ´æ¨¡å¼ä¸€è‡´çš„åœ†å½¢å°æŒ‰é’® */
    .round-row{display:flex;justify-content:center;gap:8px;margin-top:6px}
    .round-btn{background:#4a6fa5;color:#fff;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;border:none;cursor:pointer}
    .round-btn:hover{background:#2c3e50}

    /* é€Ÿåº¦ & å¤è¯» */
    .speed-control{display:flex;align-items:center;margin-top:12px;background:#f8f9fa;padding:8px;border-radius:8px;border:1px solid #e1e4e8;font-size:14px}
    .speed-control label{margin-right:10px;font-weight:600}
    .speed-control select{padding:6px;border-radius:4px;border:1px solid #ddd}
    .loop-section{margin-top:12px;background:#f0f7ff;padding:12px;border-radius:8px;border:1px dashed #4a6fa5}
    .loop-header{font-weight:700;margin-bottom:8px}
    .loop-times{display:flex;gap:10px;margin-top:8px}
    .loop-input{width:80px;padding:5px;border-radius:4px;border:1px solid #ddd}
    .region-loop{background:rgba(74,111,165,.2);position:absolute;top:0;height:100%;pointer-events:none}

    /* æ¸…ç©ºæŒ‰é’®ï¼ˆä»…å›¾æ ‡ï¼‰ */
    .player-footer{margin-top:12px;display:flex;justify-content:flex-end}
    .icon-only{background:#e74c3c;color:#fff;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:none;cursor:pointer}
    .icon-only:hover{background:#c0392b}

    /* ç®€æ´æ¨¡å¼ */
    .lite-mode-container{position:fixed;inset:0;background:#f8f9fa;z-index:1000;display:none;justify-content:center;align-items:center}
    .lite-player{width:280px;max-width:92vw;padding:8px;border-radius:10px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .lite-toolbar{display:flex;justify-content:flex-end;gap:6px}
    .lite-toggle{background:#4a6fa5;color:#fff;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;border:none}
    .lite-speed select{font-size:11px;padding:2px 6px}
    .progress-container{width:100%;height:6px;background:#e1e4e8;border-radius:4px;margin:6px 0;overflow:hidden}
    .progress-bar{height:100%;width:0;background:#4a6fa5}
    .lite-controls{display:flex;justify-content:center;gap:6px}
    .lite-control-button{background:#4a6fa5;color:#fff;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:none}
    .lite-control-button:hover{background:#2c3e50}

    /* æ‹–æ”¾ */
    .drop-area{border:2px dashed #4a6fa5;border-radius:8px;padding:18px;text-align:center;background:#f0f7ff;margin-bottom:12px}
    .drop-area.drag-over{background:#e3f2fd;border-color:#2196f3;}
  </style>
</head>
<body>
  <div class="container">
    <h1>çŒ«jio Player</h1>

    <div class="local-file-section">
      <div class="tip-box">ä½¿ç”¨æµè§ˆå™¨ File API ç›´æ¥æ’­æ”¾æœ¬åœ°æ–‡ä»¶ï¼ˆä¸ä¸Šä¼ ï¼‰ã€‚å…³é—­é¡µé¢åæ”¯æŒè‡ªåŠ¨/ä¸€é”®æ¢å¤ã€‚</div>
      <div id="message" class="message-box"></div>
      <div id="dropArea" class="drop-area">æ‹–æ”¾éŸ³é¢‘æ–‡ä»¶åˆ°è¿™é‡Œ</div>

      <div class="controls">
        <input type="file" id="audioFiles" accept=".mp3,.wav,.ogg,.m4a,.flac" multiple>
        <button id="addFilesButton" class="add-button">æ·»åŠ æ–‡ä»¶</button>
        <button id="addByPickerButton" class="add-button small-button">ç³»ç»Ÿæ–‡ä»¶é€‰æ‹©å™¨ï¼ˆå¯æ¢å¤ï¼‰</button>
        <button id="restoreButton" class="add-button small-button">ä¸€é”®æ¢å¤ä¸Šæ¬¡åˆ—è¡¨</button>
        <button id="addFolderButton" class="add-button small-button">æ·»åŠ æ–‡ä»¶å¤¹ï¼ˆå°½é‡ï¼‰</button>
        <button id="importZipButton" class="add-button small-button">å¯¼å…¥ ZIP</button>
      </div>
    </div>

    <div class="player-section">
      <h2 style="margin:10px 0">æˆ‘çš„éŸ³é¢‘åº“</h2>
      <!-- å•åˆ—è¡¨æ¡†ï¼ˆå¯èšç„¦ä»¥æ”¯æŒé”®ç›˜ï¼‰ -->
      <div id="playlistBox" class="playlist-box" tabindex="0" aria-label="æ’­æ”¾åˆ—è¡¨ï¼ˆâ†‘â†“é€‰æ‹©ï¼ŒEnteræ’­æ”¾ï¼‰"></div>

      <div id="currentPlayer" class="current-player" style="display:none;">
        <div id="currentTitle" class="current-title">å½“å‰æ’­æ”¾ï¼š</div>

        <div class="waveform-container">
          <div id="waveform"></div>
        </div>
        <div class="time-display"><span id="currentTime">00:00</span> / <span id="totalTime">00:00</span></div>

        <!-- ä¸»æ§æŒ‰é’®ï¼šä¸ç®€æ´æ¨¡å¼ä¸€è‡´ -->
        <div class="round-row">
          <button id="fullPrevButton"   class="round-btn" title="ä¸Šä¸€é¦–">â®ï¸</button>
          <button id="fullRewButton"    class="round-btn" title="åé€€5ç§’">âª</button>
          <button id="fullPlayPauseButton" class="round-btn" title="æ’­æ”¾/æš‚åœ">â–¶ï¸</button>
          <button id="fullFwdButton"    class="round-btn" title="å‰è¿›5ç§’">â©</button>
          <button id="fullNextButton"   class="round-btn" title="ä¸‹ä¸€é¦–">â­ï¸</button>
        </div>

        <!-- é€Ÿåº¦åœ¨å¤è¯»å‰ -->
        <div class="speed-control">
          <label for="playbackSpeed">æ’­æ”¾é€Ÿåº¦:</label>
          <select id="playbackSpeed">
            <option value="0.5">0.5x</option>
            <option value="0.75">0.75x</option>
            <option value="1" selected>1.0x (æ­£å¸¸)</option>
            <option value="1.25">1.25x</option>
            <option value="1.5">1.5x</option>
            <option value="1.75">1.75x</option>
            <option value="2">2.0x</option>
          </select>
        </div>

        <!-- é€‰æ®µå¤è¯» -->
        <div class="loop-section">
          <div class="loop-header">é€‰æ®µå¤è¯»</div>
          <div class="controls" style="margin-top:0">
            <button id="setLoopStartBtn" class="small-button" style="background:#4a6fa5;color:#fff">è®¾ä¸ºå¼€å§‹</button>
            <button id="setLoopEndBtn" class="small-button" style="background:#4a6fa5;color:#fff">è®¾ä¸ºç»“æŸ</button>
            <button id="startLoopBtn" class="small-button" style="background:#4a6fa5;color:#fff">å¼€å§‹å¤è¯»</button>
            <button id="stopLoopBtn" class="small-button" style="background:#4a6fa5;color:#fff">åœæ­¢å¤è¯»</button>
          </div>
          <div style="margin-top:6px">
            <label for="loopCount">å¤è¯»æ¬¡æ•° (0=æ— é™):</label>
            <input id="loopCount" type="number" min="0" value="3" class="loop-input">
          </div>
          <div class="loop-times">
            <div><label for="loopStart">å¼€å§‹(ç§’):</label><input id="loopStart" type="number" min="0" step="0.1" value="0" class="loop-input"></div>
            <div><label for="loopEnd">ç»“æŸ(ç§’):</label><input id="loopEnd" type="number" min="0" step="0.1" value="0" class="loop-input"></div>
          </div>
        </div>

        <!-- åº•éƒ¨ï¼šæ¸…ç©ºåˆ—è¡¨ï¼ˆåƒåœ¾æ¡¶å›¾æ ‡ï¼‰ -->
        <div class="player-footer">
          <button id="clearPlaylistBtn" class="icon-only" title="æ¸…ç©ºåˆ—è¡¨">ğŸ—‘ï¸</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç®€æ´æ¨¡å¼ -->
  <div id="liteModeContainer" class="lite-mode-container">
    <div class="lite-player">
      <div class="lite-toolbar">
        <button id="liteToggleBtn" class="lite-toggle" title="åˆ‡æ¢å®Œæ•´æ¨¡å¼">ğŸ”„</button>
        <div class="lite-speed">
          <select id="litePlaybackSpeed">
            <option value="0.5">0.5x</option><option value="0.75">0.75x</option>
            <option value="1" selected>1x</option><option value="1.25">1.25x</option>
            <option value="1.5">1.5x</option><option value="1.75">1.75x</option>
            <option value="2">2x</option>
          </select>
        </div>
      </div>
      <div id="liteTitleDisplay" style="text-align:center;font-weight:600;margin:6px 0 2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">å½“å‰æ’­æ”¾ï¼š</div>
      <div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>
      <div class="time-display"><span id="liteCurrentTime">00:00</span> / <span id="liteTotalTime">00:00</span></div>
      <div class="lite-controls">
        <button id="litePrevButton" class="lite-control-button">â®ï¸</button>
        <button id="liteRewindButton" class="lite-control-button">âª</button>
        <button id="litePlayPauseButton" class="lite-control-button">â–¶ï¸</button>
        <button id="liteForwardButton" class="lite-control-button">â©</button>
        <button id="liteNextButton" class="lite-control-button">â­ï¸</button>
      </div>
    </div>
  </div>

  <script>
    let wavesurfer=null,isLooping=false,loopCounter=0,loopRegion=null;
    let audioFiles=[],currentAudioFile=null,currentAudio=null,updateTimer=null,isLiteMode=false;

    // ç®€æ˜“å­˜å‚¨ï¼ˆåŒä¸Šç‰ˆï¼‰
    const DB_NAME='catpaw-player', STORE='playlist';
    function idb(){return new Promise((res,rej)=>{const r=indexedDB.open(DB_NAME,1);r.onupgradeneeded=()=>r.result.createObjectStore(STORE);r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error);});}
    async function idbSet(key,val){const db=await idb();return new Promise((res,rej)=>{const tx=db.transaction(STORE,'readwrite');tx.objectStore(STORE).put(val,key);tx.oncomplete=()=>res();tx.onerror=()=>rej(tx.error);});}
    async function idbGet(key){const db=await idb();return new Promise((res,rej)=>{const tx=db.transaction(STORE,'readonly');const rq=tx.objectStore(STORE).get(key);rq.onsuccess=()=>res(rq.result);rq.onerror=()=>rej(rq.error);});}
    const hasFS='showOpenFilePicker' in window;

    function showMessage(t,type){const m=document.getElementById('message');m.textContent=t;m.className='message-box '+(type==='error'?'error-message':'success-message');}

    function isAudioExt(name){return ['.mp3','.wav','.ogg','.m4a','.flac','.aac'].some(ext=>name.toLowerCase().endsWith(ext));}

    // æ’åºï¼ˆæ–‡ä»¶åè‡ªç„¶é¡ºåºï¼‰
    function sortPlaylist(){ audioFiles.sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true,sensitivity:'base'})); }

    // â€”â€” æ’­æ”¾åˆ—è¡¨æ¸²æŸ“ + æ­£åœ¨æ’­æ”¾æŒ‡ç¤º + é”®ç›˜é€‰ä¸­æ€ â€”â€”
    let selectedIndex = -1; // é”®ç›˜é€‰æ‹©é«˜äº®
    function renderPlaylist(){
      const box=document.getElementById('playlistBox'); box.innerHTML='';
      if(!audioFiles.length){box.innerHTML='<div class="playlist-item" style="justify-content:center;color:#888">æ²¡æœ‰éŸ³é¢‘æ–‡ä»¶ï¼Œè¯·æ·»åŠ </div>';return;}
      audioFiles.forEach((f,i)=>{
        const li=document.createElement('div'); li.className='playlist-item'; li.dataset.index=i;
        // æŒ‡ç¤ºç‚¹
        const dot=document.createElement('div'); dot.className='np';
        const span=document.createElement('span'); span.className='playlist-name'; span.textContent=f.name;
        li.appendChild(dot); li.appendChild(span);
        if(currentAudioFile && currentAudioFile.name===f.name) li.classList.add('active');
        if(i===selectedIndex) li.classList.add('selected');

        li.addEventListener('click',()=>playAudio(f,i));
        box.appendChild(li);
      });
    }
    function setSelected(i){
      if(!audioFiles.length) {selectedIndex=-1; return;}
      selectedIndex = Math.max(0, Math.min(audioFiles.length-1, i));
      renderPlaylist();
      // å°½é‡æŠŠé€‰ä¸­é¡¹æ»šåŠ¨è¿›å¯è§†åŒº
      const el=document.querySelector(`.playlist-item[data-index="${selectedIndex}"]`);
      if(el){ el.scrollIntoView({block:'nearest'}); }
    }

    // é”®ç›˜å¯¼èˆª
    const playlistBox = document.getElementById('playlistBox');
    playlistBox.addEventListener('keydown', (e)=>{
      if(!audioFiles.length) return;
      if(e.key==='ArrowDown'){ setSelected((selectedIndex<0?0:selectedIndex+1)); e.preventDefault(); }
      else if(e.key==='ArrowUp'){ setSelected((selectedIndex<0?0:selectedIndex-1)); e.preventDefault(); }
      else if(e.key==='Home'){ setSelected(0); e.preventDefault(); }
      else if(e.key==='End'){ setSelected(audioFiles.length-1); e.preventDefault(); }
      else if(e.key==='Enter'){ if(selectedIndex>=0) playAudio(audioFiles[selectedIndex], selectedIndex); }
    });

    // â€”â€” æ·»åŠ æ–‡ä»¶ / æ‹–æ”¾ â€”â€”
    document.getElementById('addFilesButton').addEventListener('click',()=>document.getElementById('audioFiles').click());
    document.getElementById('audioFiles').addEventListener('change',e=>{
      const files=Array.from(e.target.files).filter(f=>f.type.startsWith('audio/')||isAudioExt(f.name)).map(f=>({name:f.name,path:URL.createObjectURL(f),file:f}));
      audioFiles.push(...files); sortPlaylist(); renderPlaylist(); savePersistentPlaylist();
      if(selectedIndex<0 && audioFiles.length) setSelected(0);
      showMessage(`å·²æ·»åŠ  ${files.length} ä¸ªæ–‡ä»¶`,`success`);
      if(!currentAudioFile && audioFiles.length) playAudio(audioFiles[0],0);
      e.target.value='';
    });

    const drop=document.getElementById('dropArea');
    ['dragenter','dragover','dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();}));
    ['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,()=>drop.classList.add('drag-over')));
    ['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,()=>drop.classList.remove('drag-over')));
    drop.addEventListener('drop',e=>{
      const files=Array.from(e.dataTransfer.files).filter(f=>f.type.startsWith('audio/')||isAudioExt(f.name)).map(f=>({name:f.name,path:URL.createObjectURL(f),file:f}));
      audioFiles.push(...files); sortPlaylist(); renderPlaylist(); savePersistentPlaylist();
      if(selectedIndex<0 && audioFiles.length) setSelected(0);
      showMessage(`æ‹–å…¥ ${files.length} ä¸ªæ–‡ä»¶`,`success`);
      if(!currentAudioFile && audioFiles.length) playAudio(audioFiles[0],0);
    });

    // å…¶ä»–æ·»åŠ æ–¹å¼ï¼ˆä¿ç•™ï¼‰
    const hasFS='showOpenFilePicker' in window;
    async function pickMultipleFiles(){
      if(hasFS){
        const handles=await window.showOpenFilePicker({multiple:true,types:[{description:'Audio',accept:{'audio/*':['.mp3','.m4a','.wav','.flac','.ogg','.aac']}}]});
        const files=[]; for(const h of handles){const f=await h.getFile(); files.push({name:f.name,path:URL.createObjectURL(f),file:f,handle:h});}
        return files;
      }else{ return new Promise(res=>{const i=document.createElement('input');i.type='file';i.multiple=true;i.accept='audio/*';i.onchange=()=>res(Array.from(i.files).map(f=>({name:f.name,path:URL.createObjectURL(f),file:f})));i.click();}); }
    }
    async function pickDirectoryFilesOrFallback(accept='audio/*'){
      const test=document.createElement('input'); if('webkitdirectory' in test){
        return new Promise(res=>{const i=document.createElement('input');i.type='file';i.multiple=true;i.accept=accept;i.webkitdirectory=true;i.onchange=()=>res(Array.from(i.files).map(f=>({name:f.name,path:URL.createObjectURL(f),file:f})));i.click();});
      } else { return await pickMultipleFiles(); }
    }
    async function importZipToPlaylist(zipFile){
      try{
        const buf=await zipFile.arrayBuffer(); const zip=await JSZip.loadAsync(buf); const entries=[];
        zip.forEach((p,e)=>{ if(!e.dir && isAudioExt(e.name)) entries.push(e); });
        if(!entries.length){ showMessage('ZIP ä¸­æœªå‘ç°éŸ³é¢‘','error'); return; }
        const added=[];
        for(const e of entries){ const blob=await e.async('blob'); const name=e.name.split('/').pop(); added.push({name,path:URL.createObjectURL(blob),file:new File([blob],name,{type:blob.type})}); }
        audioFiles.push(...added); sortPlaylist(); renderPlaylist(); savePersistentPlaylist(); showMessage(`å·²ä» ZIP å¯¼å…¥ ${added.length} ä¸ªæ–‡ä»¶`,'success');
        if(selectedIndex<0 && audioFiles.length) setSelected(0);
        if(!currentAudioFile) playAudio(audioFiles[0],0);
      }catch(e){console.error(e); showMessage('ZIP å¯¼å…¥å¤±è´¥','error');}
    }

    document.getElementById('addByPickerButton').addEventListener('click',async()=>{
      const files=await pickMultipleFiles(); if(!files.length) return;
      audioFiles.push(...files); sortPlaylist(); renderPlaylist(); savePersistentPlaylist(); showMessage(`æ·»åŠ  ${files.length} ä¸ªæ–‡ä»¶`,'success');
      if(selectedIndex<0 && audioFiles.length) setSelected(0);
      if(!currentAudioFile) playAudio(audioFiles[0],0);
    });
    document.getElementById('addFolderButton').addEventListener('click',async()=>{
      const files=await pickDirectoryFilesOrFallback('audio/*'); if(!files.length) return;
      audioFiles.push(...files); sortPlaylist(); renderPlaylist(); savePersistentPlaylist(); showMessage(`æ·»åŠ  ${files.length} ä¸ªæ–‡ä»¶`,'success');
      if(selectedIndex<0 && audioFiles.length) setSelected(0);
      if(!currentAudioFile) playAudio(audioFiles[0],0);
    });
    document.getElementById('importZipButton').addEventListener('click',()=>{
      const i=document.createElement('input'); i.type='file'; i.accept='.zip,application/zip'; i.onchange=()=>{ if(i.files[0]) importZipToPlaylist(i.files[0]); }; i.click();
    });

    // â€”â€” WaveSurfer â€”â€”
    function initWaveSurfer(){
      wavesurfer=WaveSurfer.create({container:'#waveform',waveColor:'#4a6fa5',progressColor:'#2c3e50',cursorColor:'#e74c3c',barWidth:2,barGap:1,height:100,normalize:true});
      wavesurfer.on('ready',()=>{
        document.getElementById('totalTime').textContent=formatTime(wavesurfer.getDuration());
        document.getElementById('loopEnd').value=wavesurfer.getDuration().toFixed(1);
      });
      wavesurfer.on('audioprocess',()=>{
        const t=wavesurfer.getCurrentTime(); document.getElementById('currentTime').textContent=formatTime(t);
        if(isLiteMode && currentAudio){ // ç®€æ´æ¨¡å¼è¿›åº¦æ¡
          const pct=(currentAudio.currentTime/currentAudio.duration)*100 || 0;
          document.getElementById('progressBar').style.width=pct+'%';
          document.getElementById('liteCurrentTime').textContent=formatTime(currentAudio.currentTime||0);
        }
      });
    }
    initWaveSurfer();

    function formatTime(s){const m=Math.floor(s/60),ss=Math.floor(s%60);return `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;}

    function playAudio(file,index){
      const player=document.getElementById('currentPlayer'); player.style.display='block';
      currentAudioFile=file; currentAudioFile.index=index;
      document.getElementById('currentTitle').textContent='å½“å‰æ’­æ”¾ï¼š'+file.name;
      document.getElementById('liteTitleDisplay').textContent=file.name;

      wavesurfer.load(file.path);
      // æ›´æ–°åˆ—è¡¨é«˜äº® & é”®ç›˜é€‰ä¸­æ€
      selectedIndex = index;
      renderPlaylist();

      // è‡ªåŠ¨æ’­æ”¾
      setTimeout(()=>{ if(!wavesurfer.isPlaying()) wavesurfer.play(); document.getElementById('fullPlayPauseButton').textContent='â¸ï¸'; document.getElementById('litePlayPauseButton').textContent='â¸ï¸'; }, 50);
    }

    // ä¸»æ§æŒ‰é’®
    document.getElementById('fullPlayPauseButton').addEventListener('click',()=>{
      if(wavesurfer.isPlaying()){ wavesurfer.pause(); document.getElementById('fullPlayPauseButton').textContent='â–¶ï¸'; document.getElementById('litePlayPauseButton').textContent='â–¶ï¸'; }
      else { wavesurfer.play();  document.getElementById('fullPlayPauseButton').textContent='â¸ï¸'; document.getElementById('litePlayPauseButton').textContent='â¸ï¸'; }
    });
    document.getElementById('fullRewButton').addEventListener('click',()=>{ const t=wavesurfer.getCurrentTime(); wavesurfer.seekTo(Math.max(0,t-5)/wavesurfer.getDuration()); });
    document.getElementById('fullFwdButton').addEventListener('click',()=>{ const t=wavesurfer.getCurrentTime(); wavesurfer.seekTo(Math.min(wavesurfer.getDuration(),t+5)/wavesurfer.getDuration()); });

    function navTrack(step){
      if(!audioFiles.length||currentAudioFile==null) return;
      sortPlaylist();
      let i=currentAudioFile.index ?? audioFiles.findIndex(f=>f.name===currentAudioFile.name);
      if(i<0) i=0;
      let n=i+step; if(n<0) n=audioFiles.length-1; if(n>=audioFiles.length) n=0;
      playAudio(audioFiles[n],n);
    }
    document.getElementById('fullPrevButton').addEventListener('click',()=>navTrack(-1));
    document.getElementById('fullNextButton').addEventListener('click',()=>navTrack(1));

    // é€Ÿåº¦åŒæ­¥
    document.getElementById('playbackSpeed').addEventListener('change',function(){ const s=parseFloat(this.value); wavesurfer.setPlaybackRate(s); document.getElementById('litePlaybackSpeed').value=this.value; });
    document.getElementById('litePlaybackSpeed').addEventListener('change',function(){ const s=parseFloat(this.value); wavesurfer.setPlaybackRate(s); document.getElementById('playbackSpeed').value=this.value; });

    // ç®€æ´æ¨¡å¼ä¸å®Œæ•´æ¨¡å¼åˆ‡æ¢ï¼ˆä¿ç•™åŸé€»è¾‘ï¼‰
    const lite=document.getElementById('liteModeContainer');
    document.getElementById('liteToggleBtn').addEventListener('click',()=>{ lite.style.display='none'; });
    document.getElementById('litePlayPauseButton').addEventListener('click',()=>document.getElementById('fullPlayPauseButton').click());
    document.getElementById('liteRewindButton').addEventListener('click',()=>document.getElementById('fullRewButton').click());
    document.getElementById('liteForwardButton').addEventListener('click',()=>document.getElementById('fullFwdButton').click());
    document.getElementById('litePrevButton').addEventListener('click',()=>navTrack(-1));
    document.getElementById('liteNextButton').addEventListener('click',()=>navTrack(1));

    // æ¸…ç©ºåˆ—è¡¨
    document.getElementById('clearPlaylistBtn').addEventListener('click',()=>{
      if(!audioFiles.length) return;
      if(confirm('ç¡®å®šæ¸…ç©ºæ’­æ”¾åˆ—è¡¨å—ï¼Ÿ')){
        audioFiles.forEach(f=>{try{URL.revokeObjectURL(f.path);}catch(_){}});
        audioFiles=[]; renderPlaylist();
        document.getElementById('currentPlayer').style.display='none';
        currentAudioFile=null; selectedIndex=-1;
        localStorage.removeItem('audioPlaylistManifest'); idbSet('handles',null);
        showMessage('å·²æ¸…ç©ºåˆ—è¡¨','success');
      }
    });

    // è‡ªåŠ¨æ¢å¤ï¼ˆæ¸…å•/å¥æŸ„ï¼‰
    (async function autoRestore(){
      try{
        const saved=await idbGet('handles');
        if(hasFS && saved && saved.length){
          const rebuilt=[];
          for(const it of saved){ const h=it.handle; if(h && (await h.queryPermission?.({mode:'read'}))!=='granted'){ const r=await h.requestPermission?.({mode:'read'}); if(r!=='granted') throw 0; } const f=await h.getFile(); rebuilt.push({name:f.name,path:URL.createObjectURL(f),file:f,handle:h}); }
          if(rebuilt.length){ audioFiles=rebuilt; sortPlaylist(); renderPlaylist(); setSelected(0); showMessage('å·²è‡ªåŠ¨æ¢å¤ä¸Šæ¬¡æ’­æ”¾åˆ—è¡¨ âœ…','success'); return; }
        }
        const manifest=localStorage.getItem('audioPlaylistManifest'); if(manifest){ showMessage('æ‰¾åˆ°ä¸Šæ¬¡æ¸…å•ï¼Œå¯ç”¨â€œä¸€é”®æ¢å¤ä¸Šæ¬¡åˆ—è¡¨â€è¿›è¡ŒåŒ¹é…','success'); }
      }catch(e){}
    })();

    // ä¸€é”®æ¢å¤
    document.getElementById('restoreButton').addEventListener('click',async()=>{
      try{
        const manifestStr=localStorage.getItem('audioPlaylistManifest'); if(!manifestStr){showMessage('æ²¡æœ‰å¯æ¢å¤çš„æ¸…å•','error');return;}
        const manifest=JSON.parse(manifestStr); const picked=await pickDirectoryFilesOrFallback('audio/*');
        const map=new Map(picked.map(p=>[(p.name+'::'+(p.file?.size||0)),p]));
        const matched=[]; for(const m of manifest){ const key=m.name+'::'+(m.size||0); matched.push(map.get(key)||picked.find(p=>p.name===m.name)); }
        const final=matched.filter(Boolean); if(!final.length){showMessage('æœªåŒ¹é…åˆ°æ–‡ä»¶','error');return;}
        audioFiles=final; sortPlaylist(); renderPlaylist(); setSelected(0); showMessage(`å·²æ¢å¤ ${final.length} ä¸ªæ–‡ä»¶ âœ…`,'success'); playAudio(audioFiles[0],0);
      }catch(e){console.error(e); showMessage('æ¢å¤å¤±è´¥','error');}
    });

    // åˆå§‹æ¸²æŸ“
    renderPlaylist();
  </script>
</body>
</html>
