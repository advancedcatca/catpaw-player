<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>猫jio Player</title>
  <!-- WaveSurfer -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/6.6.3/wavesurfer.min.js"></script>
  <!-- JSZip：用于导入 ZIP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <style>
    body{font-family:'Arial',sans-serif;max-width:800px;margin:0 auto;padding:20px;background:#f8f9fa;position:relative;}
    body::before{content:"";position:fixed;top:50%;left:50%;width:100%;height:100%;transform:translate(-50%,-50%);
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200' width='200' height='200' opacity='0.1'%3E%3Cpath d='M100,15 C130,15 150,40 150,70 C150,100 130,125 100,125 C70,125 50,100 50,70 C50,40 70,15 100,15 Z M35,40 C40,20 20,25 15,10 C10,25 20,40 35,40 Z M165,40 C160,20 180,25 185,10 C190,25 180,40 165,40 Z M50,145 C65,180 135,180 150,145 C160,120 140,125 100,125 C60,125 40,120 50,145 Z'/%3E%3C/svg%3E");
      background-repeat:no-repeat;background-position:center;background-size:80% auto;z-index:-1;opacity:.07;}
    h1{color:#333;text-align:center;position:relative;padding-bottom:15px;}
    h1::after{content:"🐾";position:absolute;font-size:24px;bottom:-10px;right:30%;transform:rotate(15deg);}
    h1::before{content:"🐾";position:absolute;font-size:24px;bottom:-5px;left:30%;transform:rotate(-15deg);}

    .container{background:#fff;border-radius:12px;padding:25px;box-shadow:0 5px 15px rgba(0,0,0,.1);position:relative;}
    .container::before{content:"🐾";position:absolute;font-size:20px;top:10px;right:15px;opacity:.3;}

    .local-file-section{margin-bottom:30px;padding-bottom:20px;border-bottom:2px dotted #eee;}
    .player-section{margin-top:20px;}
    .audio-list{list-style:none;padding:0;max-height:300px;overflow-y:auto;}

    .audio-item{border:1px solid #e1e4e8;border-radius:8px;margin-bottom:12px;padding:12px;display:flex;align-items:center;background:#f9f9f9;transition:all .3s ease;}
    .audio-name{flex-grow:1;margin-left:12px;font-weight:500;color:#444;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    button{border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:500;transition:all .2s;margin-right:5px;}
    button:hover{transform:translateY(-2px);box-shadow:0 3px 5px rgba(0,0,0,.1);}
    .play-button{background:#4a6fa5;color:#fff;}
    .remove-button{background:#e74c3c;color:#fff;}

    .local-form{display:flex;flex-direction:column;gap:12px;}
    .file-input-container{margin-bottom:10px;}
    .add-button{background:#27ae60;color:#fff;padding:10px 15px;font-weight:700;}
    .small-button{font-size:14px;padding:6px 10px;border-radius:4px;}

    /* 隐藏文件选择器（方法A） */
    #audioFiles{display:none;}

    .current-player{margin-top:25px;border:1px solid #e1e4e8;border-radius:10px;padding:20px;background:#fff;box-shadow:0 3px 10px rgba(0,0,0,.05);}
    .current-title{font-weight:700;margin-bottom:12px;color:#2c3e50;display:flex;align-items:center;}
    .current-title::before{content:"🐾";margin-right:8px;font-size:18px;}

    /* 一排按钮（完整模式） */
    .controls{display:flex;align-items:center;justify-content:center;gap:6px;margin-top:15px;flex-wrap:wrap;}
    .control-button{background:#4a6fa5;color:#fff;padding:8px 14px;}
    @media (max-width:600px){.controls{flex-wrap:nowrap;overflow-x:auto;}}

    .time-display{font-family:monospace;text-align:center;margin:10px 0;font-size:14px;color:#666;}

    /* 波形 */
    #waveform{margin:15px 0;background:#f8f9fa;border-radius:8px;overflow:hidden;height:100px;position:relative;}
    .waveform-container{margin-top:15px;border:1px solid #e1e4e8;border-radius:8px;padding:15px;background:#f9f9f9;}
    .waveform-title{font-weight:700;margin-bottom:10px;color:#2c3e50;}
    .region-loop{background:rgba(74,111,165,.2);border-radius:4px;}

    /* 播放速度/复读 —— 字号更小更紧凑 */
    .speed-control{display:flex;align-items:center;margin-top:12px;background:#f8f9fa;padding:8px;border-radius:8px;border:1px solid #e1e4e8;font-size:14px;}
    .speed-control label{margin-right:10px;font-size:14px;font-weight:600;color:#444;}
    .speed-control select{padding:6px;border-radius:4px;border:1px solid #ddd;}

    .loop-section{margin-top:16px;background:#f0f7ff;padding:12px;border-radius:8px;border:1px dashed #4a6fa5;}
    .loop-header{font-weight:700;color:#2c3e50;margin-bottom:8px;display:flex;align-items:center;font-size:16px;}
    .loop-header::before{content:"🔁";margin-right:8px;}
    .loop-section label{font-size:14px;font-weight:500;}
    .loop-times{display:flex;justify-content:space-between;margin-bottom:12px;gap:8px;}
    .loop-input{width:70px;padding:5px;border-radius:4px;border:1px solid #ddd;}

    .confirm-dialog{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:1000;}
    .dialog-content{background:#fff;padding:25px;border-radius:10px;max-width:400px;text-align:center;box-shadow:0 5px 20px rgba(0,0,0,.2);}
    .dialog-content::before{content:"🐾";display:block;font-size:30px;margin-bottom:15px;}
    .dialog-buttons{display:flex;justify-content:center;gap:15px;margin-top:25px;}
    .confirm-btn{background:#e74c3c;color:#fff;}
    .cancel-btn{background:#7f8c8d;color:#fff;}

    /* 切换模式按钮（完整模式右上）——保持小尺寸 */
    .mode-toggle{
      position:absolute;top:15px;right:15px;background:#4a6fa5;color:#fff;
      padding:3px 6px;border-radius:10px;font-size:12px;cursor:pointer;
      transition:all .3s;display:flex;align-items:center;z-index:10;
    }
    .mode-toggle:hover{background:#2c3e50;}
    .mode-toggle::before{content:"🔄";margin-right:4px;font-size:12px;}

    /* 简洁模式容器 */
    .lite-mode-container{position:fixed;inset:0;background:#f8f9fa;z-index:1000;display:none;flex-direction:column;justify-content:center;align-items:center;}

    /* 简洁模式播放框整体缩小 */
    .lite-player{width:280px;max-width:92vw;padding:8px;border-radius:10px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.1);}
    .lite-title{text-align:center;font-weight:600;margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:14px;}
    .lite-player .time-display{margin:4px 0;font-size:11px;}

    /* 右上工具条：切换图标 + 速度选择 同一排，更紧凑 */
    .lite-toolbar{display:flex;justify-content:flex-end;align-items:center;gap:6px;margin-top:2px;margin-bottom:4px;}
    .lite-toggle{background:#4a6fa5;color:#fff;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-size:12px;border:none;cursor:pointer;}
    .lite-toggle:hover{background:#2c3e50;}
    .lite-speed{font-size:11px;}
    .lite-speed select{font-size:11px;padding:2px 6px;}

    /* 进度条更细更紧凑 */
    .progress-container{width:100%;height:6px;background:#e1e4e8;border-radius:4px;margin:6px 0;position:relative;overflow:hidden;}
    .progress-bar{height:100%;width:0%;background:#4a6fa5;border-radius:4px;transition:width .1s linear;}

    /* 一排小圆按钮更小 */
    .lite-controls{display:flex;justify-content:center;gap:6px;margin-top:6px;flex-wrap:nowrap;}
    .lite-control-button{background:#4a6fa5;color:#fff;width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:50%;font-size:14px;padding:0;}
    .lite-control-button:hover{background:#2c3e50;}

    .hidden{display:none;}
    .tip-box{background:#fff8dc;border:1px solid #f0e68c;border-radius:6px;padding:10px 15px;margin-bottom:15px;font-size:14px;color:#8b4513;line-height:1.5;}
    .tip-box::before{content:"💡";margin-right:8px;}
    .message-box{padding:10px;border-radius:6px;margin:10px 0;text-align:center;font-size:14px;display:none;}
    .success-message{background:#d4edda;color:#155724;border:1px solid #c3e6cb;}
    .error-message{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;}

    /* 拖放 */
    .drop-area{border:2px dashed #4a6fa5;border-radius:8px;padding:25px;text-align:center;margin-bottom:15px;background:#f0f7ff;transition:all .3s ease;}
    .drop-area.drag-over{background:#e3f2fd;border-color:#2196f3;}
    .drop-area p{margin:0;color:#4a6fa5;font-weight:500;}
    .or-divider{display:flex;align-items:center;margin:15px 0;color:#777;}
    .or-divider::before,.or-divider::after{content:"";flex:1;border-bottom:1px solid #ddd;}
    .or-divider span{padding:0 10px;}
  </style>
</head>
<body>
  <div class="container">
    <h1>猫jio Player</h1>

    <div class="local-file-section">
      <h2>添加本地音频</h2>
      <div class="tip-box">使用浏览器 File API 直接播放本地文件，不上传服务器。关闭页面后可<strong>自动/一键恢复</strong>（见下方按钮）。</div>

      <div id="message" class="message-box"></div>

      <div id="dropArea" class="drop-area"><p>拖放音频文件到这里</p></div>

      <div class="or-divider"><span>或者</span></div>

      <div class="local-form">
        <div class="file-input-container">
          <!-- 隐藏但保留，用于按钮触发（方法A） -->
          <input type="file" id="audioFiles" accept=".mp3,.wav,.ogg,.m4a,.flac" multiple>
        </div>
        <button type="button" id="addFilesButton" class="add-button">添加文件</button>

        <!-- 一排操作按钮（更小） -->
        <div class="controls" style="margin-top:6px;">
          <button type="button" id="addByPickerButton" class="add-button small-button">系统文件选择器（可自动恢复）</button>
          <button type="button" id="restoreButton" class="add-button small-button">一键恢复上次列表</button>
          <button type="button" id="addFolderButton" class="add-button small-button">添加整个文件夹（尽量）</button>
          <button type="button" id="importZipButton" class="add-button small-button">导入 ZIP</button>
        </div>
      </div>
    </div>

    <div class="player-section">
      <h2>我的音频库</h2>
      <ul id="audioList" class="audio-list"></ul>

      <div id="currentPlayer" class="current-player" style="display:none;">
        <button id="modeToggleBtn" class="mode-toggle">切换简洁模式</button>
        <div id="fullModeContent">
          <div id="currentTitle" class="current-title">当前播放：</div>

          <div class="waveform-container">
            <div class="waveform-title">音频波形</div>
            <div id="waveform"></div>
          </div>

          <audio id="audioPlayer" style="display:none;"></audio>

          <div class="time-display"><span id="currentTime">00:00</span> / <span id="totalTime">00:00</span></div>

          <!-- 一排主控按钮 -->
         <!-- 一排主控按钮 -->
<div class="controls">
    <button id="play-btn">播放</button>
    <button id="rewind-btn">后退5秒</button>
    <button id="forward-btn">前进5秒</button>
    <button id="toggle-mode-btn" title="切换为简洁版" style="padding: 4px 6px;">🔄</button>
</div>


          <!-- 速度调节（在复读前） -->
          <div class="speed-control">
            <label for="playbackSpeed">播放速度:</label>
            <select id="playbackSpeed">
              <option value="0.5">0.5x</option>
              <option value="0.75">0.75x</option>
              <option value="1" selected>1.0x (正常)</option>
              <option value="1.25">1.25x</option>
              <option value="1.5">1.5x</option>
              <option value="1.75">1.75x</option>
              <option value="2">2.0x</option>
            </select>
          </div>

          <!-- 选段复读（按钮→次数→开始/结束） -->
          <div class="loop-section">
            <div class="loop-header">选段复读</div>

            <div class="controls">
              <button id="setLoopStartBtn" class="control-button">设为开始</button>
              <button id="setLoopEndBtn" class="control-button">设为结束</button>
              <button id="startLoopBtn" class="control-button">开始复读</button>
              <button id="stopLoopBtn" class="control-button">停止复读</button>
            </div>

            <div style="margin-top:8px;">
              <label for="loopCount">复读次数 (0表示无限循环):</label>
              <input type="number" id="loopCount" min="0" value="3" style="width:60px;">
            </div>

            <div class="loop-times" style="margin-top:10px;">
              <div>
                <label for="loopStart">开始时间 (秒):</label>
                <input type="number" id="loopStart" class="loop-input" min="0" step="0.1" value="0">
              </div>
              <div>
                <label for="loopEnd">结束时间 (秒):</label>
                <input type="number" id="loopEnd" class="loop-input" min="0" step="0.1" value="0">
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- 简洁模式 -->
  <div id="liteModeContainer" class="lite-mode-container">
    <div id="liteModeContent" class="lite-player">
      <!-- 顶部工具条：切换图标 + 速度 -->
      <div class="lite-toolbar">
        <button id="liteModeModeToggleBtn" class="lite-toggle" title="切换完整模式">🔄</button>
        <div class="lite-speed">
          <select id="litePlaybackSpeed">
            <option value="0.5">0.5x</option>
            <option value="0.75">0.75x</option>
            <option value="1" selected>1x</option>
            <option value="1.25">1.25x</option>
            <option value="1.5">1.5x</option>
            <option value="1.75">1.75x</option>
            <option value="2">2x</option>
          </select>
        </div>
      </div>

      <div id="liteTitleDisplay" class="lite-title">当前播放：</div>

      <div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>
      <div class="time-display"><span id="liteCurrentTime">00:00</span> / <span id="liteTotalTime">00:00</span></div>

      <div class="lite-controls">
        <button id="litePrevButton" class="lite-control-button">⏮️</button>
        <button id="liteRewindButton" class="lite-control-button">⏪</button>
        <button id="litePlayPauseButton" class="lite-control-button">▶️</button>
        <button id="liteForwardButton" class="lite-control-button">⏩</button>
        <button id="liteNextButton" class="lite-control-button">⏭️</button>
      </div>
    </div>
  </div>

  <!-- 删除确认 -->
  <div id="confirmDialog" class="confirm-dialog">
    <div class="dialog-content">
      <h3>确认移除</h3>
      <p>您确定要从播放列表中移除此音频文件吗？</p>
      <div class="dialog-buttons">
        <button id="confirmRemove" class="confirm-btn">确认移除</button>
        <button id="cancelRemove" class="cancel-btn">取消</button>
      </div>
    </div>
  </div>

  <script>
    // ===== 基本变量 =====
    let wavesurfer=null, isLooping=false, loopCounter=0, loopRegion=null;
    let currentAudioFile=null, isLiteMode=false, audioFiles=[];
    let currentAudio=null, updateTimer=null;

    // ===== IndexedDB（句柄） + 能力探测 =====
    const DB_NAME='catpaw-player', STORE='playlist';
    function idb(){return new Promise((res,rej)=>{const req=indexedDB.open(DB_NAME,1);req.onupgradeneeded=()=>req.result.createObjectStore(STORE);req.onsuccess=()=>res(req.result);req.onerror=()=>rej(req.error);});}
    async function idbSet(key,val){const db=await idb();return new Promise((res,rej)=>{const tx=db.transaction(STORE,'readwrite');tx.objectStore(STORE).put(val,key);tx.oncomplete=()=>res();tx.onerror=()=>rej(tx.error);});}
    async function idbGet(key){const db=await idb();return new Promise((res,rej)=>{const tx=db.transaction(STORE,'readonly');const req=tx.objectStore(STORE).get(key);req.onsuccess=()=>res(req.result);req.onerror=()=>rej(req.error);});}
    const hasFS='showOpenFilePicker' in window;

    async function savePersistentPlaylist(){
      try{
        const entries=audioFiles.map(f=>({name:f.name,size:f.file?.size||0,handle:f.handle||null}));
        const allHaveHandles=hasFS && entries.every(e=>e.handle);
        if(allHaveHandles){
          await idbSet('handles', entries.map(e=>({handle:e.handle,name:e.name,size:e.size})));
          localStorage.setItem('audioPlaylistManifest','');
        }else{
          const manifest=entries.map(e=>({name:e.name,size:e.size}));
          localStorage.setItem('audioPlaylistManifest', JSON.stringify(manifest));
          await idbSet('handles', null);
        }
      }catch(e){console.error('保存持久化播放列表失败',e);}
    }

    // ===== 选择文件 / 目录 / ZIP =====
    async function pickMultipleFiles(){
      if(hasFS){
        const handles=await window.showOpenFilePicker({
          multiple:true,
          types:[{description:'Audio',accept:{'audio/*':['.mp3','.m4a','.wav','.flac','.ogg','.aac']}}]
        });
        const files=[];
        for(const h of handles){
          const f=await h.getFile(); const url=URL.createObjectURL(f);
          files.push({name:f.name,path:url,file:f,handle:h});
        }
        return files;
      }else{
        return new Promise(res=>{
          const inp=document.createElement('input');
          inp.type='file';inp.multiple=true;inp.accept='audio/*';
          inp.onchange=()=>res(Array.from(inp.files).map(f=>({name:f.name,path:URL.createObjectURL(f),file:f})));
          inp.click();
        });
      }
    }
    const isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)||(navigator.platform==='MacIntel'&&navigator.maxTouchPoints>1);
    async function pickDirectoryFilesOrFallback(accept='audio/*'){
      const test=document.createElement('input');
      const supportDir='webkitdirectory' in test;
      if(supportDir){
        return new Promise(res=>{
          const inp=document.createElement('input');
          inp.type='file';inp.multiple=true;inp.accept=accept;inp.webkitdirectory=true;
          inp.onchange=()=>res(Array.from(inp.files).map(f=>({name:f.name,path:URL.createObjectURL(f),file:f})));
          inp.click();
        });
      }else{
        return await pickMultipleFiles();
      }
    }
    function isAudioExt(name){const exts=['.mp3','.wav','.ogg','.m4a','.flac','.aac'];const i=name.lastIndexOf('.');return i>=0&&exts.includes(name.slice(i).toLowerCase());}
    function readFileAsArrayBuffer(file){return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=()=>rej(fr.error);fr.readAsArrayBuffer(file);});}
    async function importZipToPlaylist(zipFile){
      try{
        showMessage('正在读取 ZIP…','success');
        const buf=await readFileAsArrayBuffer(zipFile);
        const zip=await JSZip.loadAsync(buf);
        const entries=[]; zip.forEach((p,e)=>{if(!e.dir && isAudioExt(e.name)) entries.push(e);});
        if(!entries.length){showMessage('ZIP 中未发现音频文件','error');return;}
        entries.sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true,sensitivity:'base'}));
        const added=[]; let done=0;
        for(const e of entries){
          const blob=await e.async('blob'); const url=URL.createObjectURL(blob); const base=e.name.split('/').pop();
          added.push({name:base,path:url,file:new File([blob],base,{type:blob.type})});
          done++; if(done%Math.ceil(entries.length/5)===0||done===entries.length){showMessage(`正在导入：${done} / ${entries.length}`,'success');}
        }
        audioFiles.push(...added); updateAudioList(); await savePersistentPlaylist(); showMessage(`导入完成：共 ${added.length} 首 ✅`,'success');
      }catch(e){console.error(e);showMessage('导入 ZIP 失败，请检查文件是否损坏或过大','error');}
    }

    // ===== 自动恢复 =====
    async function tryAutoRestoreOnLoad(){
      const saved=await idbGet('handles');
      if(hasFS && saved && Array.isArray(saved) && saved.length){
        try{
          const rebuilt=[];
          for(const item of saved){
            const h=item.handle;
            if(h && (await h.queryPermission?.({mode:'read'}))!=='granted'){
              const r=await h.requestPermission?.({mode:'read'}); if(r!=='granted') throw new Error('permission denied');
            }
            const file=await h.getFile(); const url=URL.createObjectURL(file);
            rebuilt.push({name:file.name,path:url,file,handle:h});
          }
          if(rebuilt.length){audioFiles=rebuilt;updateAudioList();showMessage('已自动恢复上次播放列表 ✅','success');return true;}
        }catch(e){console.warn('句柄恢复失败，尝试清单匹配',e);}
      }
      const manifestStr=localStorage.getItem('audioPlaylistManifest');
      if(manifestStr){
        const manifest=JSON.parse(manifestStr);
        if(Array.isArray(manifest) && manifest.length){
          showMessage('找到上次清单，可点击“一键恢复上次列表”进行匹配恢复。','success');
        }
      }
      return false;
    }

    async function restoreByManifest(){
      try{
        const manifestStr=localStorage.getItem('audioPlaylistManifest');
        if(!manifestStr){showMessage('没有找到可用的清单','error');return;}
        const manifest=JSON.parse(manifestStr);
        if(!Array.isArray(manifest)||!manifest.length){showMessage('清单为空','error');return;}
        const picked=await pickDirectoryFilesOrFallback('audio/*');
        const byKey=new Map(picked.map(p=>[(p.name+'::'+(p.file?.size||0)),p]));
        const matched=[];
        for(const m of manifest){
          const key=m.name+'::'+(m.size||0);
          const f=byKey.get(key)||picked.find(p=>p.name===m.name);
          if(f) matched.push(f);
        }
        if(!matched.length){showMessage('未匹配到任何文件，请确认选择了相同的文件夹/文件','error');return;}
        audioFiles.forEach(f=>{try{URL.revokeObjectURL(f.path);}catch(_){}}); audioFiles=matched;
        updateAudioList(); await savePersistentPlaylist(); showMessage(`已恢复 ${matched.length} 个文件 ✅`,'success');
      }catch(e){console.error(e);showMessage('恢复失败，请重试','error');}
    }

    // ===== 初始化 =====
    document.addEventListener('DOMContentLoaded',()=>{
      initWaveSurfer();
      initFileInputs();

      document.getElementById('modeToggleBtn').addEventListener('click', togglePlayerMode);
      document.getElementById('liteModeModeToggleBtn').addEventListener('click', togglePlayerMode);

      document.querySelector('.progress-container').addEventListener('click',function(e){
        const r=this.getBoundingClientRect(); const pos=(e.clientX-r.left)/r.width;
        if(currentAudio){ currentAudio.currentTime=currentAudio.duration*pos; updateProgressBar(); }
      });

      document.getElementById('addByPickerButton').addEventListener('click', async ()=>{
        const files=await pickMultipleFiles(); if(!files.length) return;
        audioFiles.push(...files); updateAudioList(); await savePersistentPlaylist();
        showMessage(`成功添加 ${files.length} 个文件（已开启可恢复）`,'success');
      });
      document.getElementById('restoreButton').addEventListener('click', restoreByManifest);
      document.getElementById('addFolderButton').addEventListener('click', async ()=>{
        const files=await pickDirectoryFilesOrFallback('audio/*'); if(!files.length) return;
        audioFiles.push(...files); updateAudioList(); await savePersistentPlaylist();
        showMessage(`已添加 ${files.length} 个文件${isIOS ? '（iOS 模式）' : ''}。`,'success');
      });
      document.getElementById('importZipButton').addEventListener('click',()=>{
        const inp=document.createElement('input'); inp.type='file'; inp.accept='.zip,application/zip';
        inp.onchange=async()=>{ if(inp.files&&inp.files[0]) await importZipToPlaylist(inp.files[0]); }; inp.click();
      });

      tryAutoRestoreOnLoad();
    });

    // ===== WaveSurfer =====
    function initWaveSurfer(){
      wavesurfer=WaveSurfer.create({
        container:'#waveform', waveColor:'#4a6fa5', progressColor:'#2c3e50', cursorColor:'#e74c3c',
        barWidth:2, barGap:1, responsive:true, height:100, normalize:true, plugins:[]
      });
      wavesurfer.on('ready',()=>{
        const d=wavesurfer.getDuration();
        document.getElementById('totalTime').textContent=formatTime(d);
        document.getElementById('liteTotalTime').textContent=formatTime(d);
        document.getElementById('loopEnd').value=d.toFixed(1);
        if(isLiteMode && currentAudio) currentAudio.play();
      });
      wavesurfer.on('audioprocess',()=>{
        const t=wavesurfer.getCurrentTime();
        document.getElementById('currentTime').textContent=formatTime(t);
        if(isLooping){
          const loopEnd=parseFloat(document.getElementById('loopEnd').value);
          if(t>=loopEnd){
            const max=parseInt(document.getElementById('loopCount').value);
            if(max===0 || loopCounter<max){
              const start=parseFloat(document.getElementById('loopStart').value);
              wavesurfer.seekTo(start/wavesurfer.getDuration());
              if(max>0) loopCounter++;
            }else{
              isLooping=false;
              if(loopRegion) loopRegion.element.style.backgroundColor='rgba(74,111,165,0.1)';
            }
          }
        }
      });
      wavesurfer.on('play',()=>{
        document.getElementById('playPauseButton').textContent="暂停";
        document.getElementById('litePlayPauseButton').textContent="⏸️";
        if(isLiteMode && currentAudio && currentAudio.paused) currentAudio.play();
      });
      wavesurfer.on('pause',()=>{
        document.getElementById('playPauseButton').textContent="播放";
        document.getElementById('litePlayPauseButton').textContent="▶️";
        if(isLiteMode && currentAudio && !currentAudio.paused) currentAudio.pause();
      });
      document.getElementById('playPauseButton').addEventListener('click', togglePlayPause);
      document.getElementById('litePlayPauseButton').addEventListener('click', togglePlayPause);
    }

    // ===== 文件添加/拖放 =====
    function initFileInputs(){
      document.getElementById('addFilesButton').addEventListener('click',()=>document.getElementById('audioFiles').click());
      document.getElementById('audioFiles').addEventListener('change',function(){ if(this.files&&this.files.length>0) handleSelectedFiles(this.files); });

      const dropArea=document.getElementById('dropArea');
      ['dragenter','dragover','dragleave','drop'].forEach(ev=>{
        dropArea.addEventListener(ev, preventDefaults, false);
        document.body.addEventListener(ev, preventDefaults, false);
      });
      ['dragenter','dragover'].forEach(ev=>dropArea.addEventListener(ev,()=>dropArea.classList.add('drag-over'),false));
      ['dragleave','drop'].forEach(ev=>dropArea.addEventListener(ev,()=>dropArea.classList.remove('drag-over'),false));
      dropArea.addEventListener('drop',e=>{
        const files=e.dataTransfer.files; if(files.length>0) handleSelectedFiles(files);
      },false);
    }
    function preventDefaults(e){e.preventDefault();e.stopPropagation();}
    function handleSelectedFiles(files){
      let added=0, invalid=0;
      for(let i=0;i<files.length;i++){
        const f=files[i];
        if(f.type.startsWith('audio/') || isAudioExt(f.name)){
          const url=URL.createObjectURL(f);
          audioFiles.push({name:f.name,path:url,file:f});
          added++;
        }else invalid++;
      }
      document.getElementById('audioFiles').value='';
      if(added>0){updateAudioList();savePersistentPlaylist();}
      let msg=added>0?`成功添加了 ${added} 个音频文件。`:'';
      if(invalid>0) msg+=`有 ${invalid} 个文件不是音频文件，已忽略。`;
      showMessage(msg||'未添加文件', added>0?'success':'error');
    }

    // ===== 列表 / 消息 =====
    function updateAudioList(){
      const ul=document.getElementById('audioList'); ul.innerHTML='';
      if(audioFiles.length===0){ul.innerHTML='<li>没有音频文件，请添加一些文件</li>';return;}
      audioFiles.forEach((file,index)=>{
        const li=document.createElement('li'); li.className='audio-item'; li.dataset.index=index;
        const playBtn=document.createElement('button'); playBtn.className='play-button'; playBtn.textContent='播放'; playBtn.addEventListener('click',()=>playAudio(file,index));
        const rmBtn=document.createElement('button'); rmBtn.className='remove-button'; rmBtn.textContent='移除'; rmBtn.addEventListener('click',()=>showRemoveConfirmation(file,index));
        const nameSpan=document.createElement('span'); nameSpan.className='audio-name'; nameSpan.title=file.name; nameSpan.textContent=file.name;
        li.appendChild(playBtn); li.appendChild(rmBtn); li.appendChild(nameSpan); ul.appendChild(li);
      });
    }
    function showMessage(text,type){
      const el=document.getElementById('message'); el.textContent=text; el.className='message-box';
      if(type==='success') el.classList.add('success-message'); else if(type==='error') el.classList.add('error-message');
      el.style.display='block'; setTimeout(()=>{el.style.display='none';},3000);
    }
    function savePersistentToLocalOnly(){ try{localStorage.setItem('audioPlaylist', JSON.stringify(audioFiles.map(f=>({name:f.name}))));}catch(e){console.error(e);} }

    // ===== 播放 / 模式 =====
    function togglePlayPause(){
      if(isLiteMode){
        if(currentAudio){
          if(currentAudio.paused){currentAudio.play();document.getElementById('litePlayPauseButton').textContent="⏸️";}
          else{currentAudio.pause();document.getElementById('litePlayPauseButton').textContent="▶️";}
        }
      }else{wavesurfer && wavesurfer.playPause();}
    }
    function updateProgressBar(){
      if(currentAudio && !isNaN(currentAudio.duration)){
        const p=(currentAudio.currentTime/currentAudio.duration)*100;
        document.getElementById('progressBar').style.width=p+'%';
        document.getElementById('liteCurrentTime').textContent=formatTime(currentAudio.currentTime);
      }
    }
    function togglePlayerMode(){
      isLiteMode=!isLiteMode;
      const full=document.querySelector('.container'), lite=document.getElementById('liteModeContainer');
      if(isLiteMode){
        full.style.display='none'; lite.style.display='flex';
        if(wavesurfer && wavesurfer.isPlaying()) wavesurfer.pause();
        if(currentAudio){
          document.getElementById('litePlayPauseButton').textContent=currentAudio.paused?"▶️":"⏸️";
          if(updateTimer) clearInterval(updateTimer); updateTimer=setInterval(updateProgressBar,100);
        }
        if(currentAudioFile) document.getElementById('liteTitleDisplay').textContent=currentAudioFile.name;
      }else{
        full.style.display='block'; lite.style.display='none';
        if(currentAudio && !currentAudio.paused){wavesurfer.play();wavesurfer.seekTo(currentAudio.currentTime/currentAudio.duration);}
      }
    }

    function playAudio(file,index){
      const currentPlayer=document.getElementById('currentPlayer');
      document.getElementById('currentTitle').textContent='当前播放: '+file.name;
      document.getElementById('liteTitleDisplay').textContent=file.name;
      currentPlayer.style.display='block';

      currentAudioFile=file; currentAudioFile.index=index;
      isLooping=false; document.getElementById('loopStart').value=0; document.getElementById('loopEnd').value=0; loopCounter=0; if(loopRegion) loopRegion=null;

      document.getElementById('playbackSpeed').value='1'; document.getElementById('litePlaybackSpeed').value='1';

      if(currentAudio){currentAudio.pause();currentAudio.remove();}
      currentAudio=new Audio(file.path);
      currentAudio.addEventListener('timeupdate', updateProgressBar);
      currentAudio.addEventListener('loadedmetadata',()=>{
        document.getElementById('liteTotalTime').textContent=formatTime(currentAudio.duration);
        if(isLiteMode){
          currentAudio.play(); document.getElementById('litePlayPauseButton').textContent="⏸️";
          if(updateTimer) clearInterval(updateTimer); updateTimer=setInterval(updateProgressBar,100);
        }
      });
      currentAudio.addEventListener('ended',()=>{
        let next=index+1; if(next>=audioFiles.length) next=0; playAudio(audioFiles[next],next);
      });

      wavesurfer.load(file.path);
      wavesurfer.on('ready',()=>{
        wavesurfer.setPlaybackRate(1); currentAudio.playbackRate=1;
        if(!isLiteMode) wavesurfer.play();
      });

      highlightPlayingItem(index);
      savePersistentToLocalOnly(); savePersistentPlaylist();
    }
    function highlightPlayingItem(index){
      document.querySelectorAll('.audio-item').forEach(it=>{it.style.backgroundColor='#f9f9f9';it.style.borderColor='#e1e4e8';});
      const cur=document.querySelector(`.audio-item[data-index="${index}"]`);
      if(cur){cur.style.backgroundColor='#e3f2fd';cur.style.borderColor='#2196f3';}
    }

    // ===== 其它控件 =====
    function formatTime(s){const m=Math.floor(s/60),sec=Math.floor(s%60);return `${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;}
    document.getElementById('rewindButton').addEventListener('click',()=>{
      if(!isLiteMode && wavesurfer){
        const t=wavesurfer.getCurrentTime(); wavesurfer.seekTo(Math.max(0,t-5)/wavesurfer.getDuration());
        if(currentAudio) currentAudio.currentTime=Math.max(0,t-5);
      }
    });
    document.getElementById('forwardButton').addEventListener('click',()=>{
      if(!isLiteMode && wavesurfer){
        const t=wavesurfer.getCurrentTime(); wavesurfer.seekTo(Math.min(wavesurfer.getDuration(),t+5)/wavesurfer.getDuration());
        if(currentAudio) currentAudio.currentTime=Math.min(currentAudio.duration,t+5);
      }
    });
    document.getElementById('liteRewindButton').addEventListener('click',()=>{
      if(currentAudio){currentAudio.currentTime=Math.max(0,currentAudio.currentTime-5);updateProgressBar();if(!isLiteMode&&wavesurfer) wavesurfer.seekTo(currentAudio.currentTime/currentAudio.duration);}
    });
    document.getElementById('liteForwardButton').addEventListener('click',()=>{
      if(currentAudio){currentAudio.currentTime=Math.min(currentAudio.duration,currentAudio.currentTime+5);updateProgressBar();if(!isLiteMode&&wavesurfer) wavesurfer.seekTo(currentAudio.currentTime/currentAudio.duration);}
    });
    document.getElementById('litePrevButton').addEventListener('click',()=>{
      if(!currentAudioFile || audioFiles.length===0) return;
      let prev=currentAudioFile.index-1; if(prev<0) prev=audioFiles.length-1; playAudio(audioFiles[prev],prev);
    });
    document.getElementById('liteNextButton').addEventListener('click',()=>{
      if(!currentAudioFile || audioFiles.length===0) return;
      let next=currentAudioFile.index+1; if(next>=audioFiles.length) next=0; playAudio(audioFiles[next],next);
    });

    // 同步速度（完整/简洁）
    document.getElementById('playbackSpeed').addEventListener('change',function(){
      const s=parseFloat(this.value); if(wavesurfer) wavesurfer.setPlaybackRate(s);
      document.getElementById('litePlaybackSpeed').value=this.value; if(currentAudio) currentAudio.playbackRate=s;
    });
    document.getElementById('litePlaybackSpeed').addEventListener('change',function(){
      const s=parseFloat(this.value); document.getElementById('playbackSpeed').value=this.value;
      if(currentAudio) currentAudio.playbackRate=s; if(wavesurfer) wavesurfer.setPlaybackRate(s);
    });

    // 循环段
    document.getElementById('setLoopStartBtn').addEventListener('click',()=>{
      const cur=wavesurfer.getCurrentTime(); const end=parseFloat(document.getElementById('loopEnd').value);
      document.getElementById('loopStart').value=cur.toFixed(1);
      if(cur>end){document.getElementById('loopEnd').value=Math.min(wavesurfer.getDuration(),cur+5).toFixed(1);}
      updateLoopRegion();
    });
    document.getElementById('setLoopEndBtn').addEventListener('click',()=>{
      const cur=wavesurfer.getCurrentTime(); const start=parseFloat(document.getElementById('loopStart').value);
      document.getElementById('loopEnd').value=cur.toFixed(1);
      if(cur<start){document.getElementById('loopStart').value=Math.max(0,cur-5).toFixed(1);}
      updateLoopRegion();
    });
    function updateLoopRegion(){
      const s=parseFloat(document.getElementById('loopStart').value);
      const e=parseFloat(document.getElementById('loopEnd').value);
      if(s>=e) return;
      if(loopRegion && loopRegion.element && loopRegion.element.parentNode){loopRegion.element.parentNode.removeChild(loopRegion.element);loopRegion=null;}
      const dur=wavesurfer.getDuration(); const sp=(s/dur)*100; const ep=(e/dur)*100;
      const wf=document.getElementById('waveform'); const el=document.createElement('div');
      el.className='region-loop'; Object.assign(el.style,{position:'absolute',left:sp+'%',width:(ep-sp)+'%',top:'0',height:'100%',pointerEvents:'none',zIndex:'1'});
      if(wf.style.position!=='relative') wf.style.position='relative'; wf.appendChild(el); loopRegion={element:el};
    }
    document.getElementById('startLoopBtn').addEventListener('click',()=>{
      const s=parseFloat(document.getElementById('loopStart').value);
      const e=parseFloat(document.getElementById('loopEnd').value);
      if(s>=e){alert('开始时间必须小于结束时间');return;}
      if(e>wavesurfer.getDuration()) document.getElementById('loopEnd').value=wavesurfer.getDuration().toFixed(1);
      isLooping=true; loopCounter=0; updateLoopRegion(); wavesurfer.seekTo(s/wavesurfer.getDuration());
      if(currentAudio) currentAudio.currentTime=s; if(!wavesurfer.isPlaying()) wavesurfer.play();
    });
    document.getElementById('stopLoopBtn').addEventListener('click',()=>{
      isLooping=false; if(loopRegion && loopRegion.element){loopRegion.element.style.backgroundColor='rgba(74,111,165,0.1)';}
    });

    // 删除
    let fileToRemove=null, indexToRemove=-1;
    function showRemoveConfirmation(file,index){fileToRemove=file;indexToRemove=index;document.getElementById('confirmDialog').style.display='flex';}
    document.getElementById('confirmRemove').addEventListener('click',()=>{if(fileToRemove!==null&&indexToRemove!==-1) removeAudio(fileToRemove,indexToRemove);document.getElementById('confirmDialog').style.display='none';});
    document.getElementById('cancelRemove').addEventListener('click',()=>{document.getElementById('confirmDialog').style.display='none';fileToRemove=null;indexToRemove=-1;});
    function removeAudio(file,index){
      if(currentAudioFile && currentAudioFile.name===file.name){
        wavesurfer.stop(); if(currentAudio) currentAudio.pause();
        document.getElementById('currentPlayer').style.display='none'; currentAudioFile=null;
      }
      URL.revokeObjectURL(file.path); audioFiles.splice(index,1); updateAudioList(); savePersistentPlaylist();
      showMessage('已移除音频文件','success');
    }
  </script>
</body>
</html>
