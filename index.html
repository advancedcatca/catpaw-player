<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>猫jio Player</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/6.6.3/wavesurfer.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    body{font-family:'Arial',sans-serif;max-width:800px;margin:0 auto;padding:20px;background:#f8f9fa;}
    h1{color:#333;text-align:center;margin:0 0 16px;}
    .container{background:#fff;border-radius:12px;padding:20px;box-shadow:0 5px 15px rgba(0,0,0,.1);}
    .local-file-section{margin-bottom:20px;padding-bottom:16px;border-bottom:2px dotted #eee;}
    .tip-box{background:#fff8dc;border:1px solid #f0e68c;border-radius:6px;padding:10px 12px;margin-bottom:12px;color:#8b4513;font-size:14px;}
    .message-box{display:none;margin:8px 0;padding:8px 10px;border-radius:6px;font-size:14px;text-align:center}
    .success-message{display:block;background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .error-message{display:block;background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .add-button{background:#27ae60;color:#fff;border:none;border-radius:6px;padding:10px 14px;font-weight:700;cursor:pointer}
    .small-button{font-size:14px;padding:6px 10px;border-radius:4px}
    #audioFiles{display:none}
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:center;margin-top:10px}

    /* 播放列表：单个列表框 */
    .playlist-box{border:1px solid #e1e4e8;border-radius:10px;padding:8px;max-height:300px;overflow:auto;background:#fafafa}
    .playlist-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:6px;cursor:pointer;font-weight:500;color:#444}
    .playlist-item:hover{background:#eef6ff}
    .playlist-item.active{background:#e3f2fd;border:1px solid #2196f3}
    .playlist-item.selected{outline:2px solid #a3c5ff;background:#f0f8ff}
    .playlist-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* 正在播放指示点 */
    .np{width:10px;height:10px;border-radius:50%;background:#4a6fa5;opacity:0;flex:0 0 auto}
    .playlist-item.active .np{opacity:1;animation:pulse 1.2s infinite ease-in-out}
    @keyframes pulse{
      0%{transform:scale(.9);opacity:.6}
      50%{transform:scale(1.2);opacity:1}
      100%{transform:scale(.9);opacity:.6}
    }

    /* 播放器 */
    .current-player{margin-top:18px;border:1px solid #e1e4e8;border-radius:10px;padding:16px;background:#fff;box-shadow:0 3px 10px rgba(0,0,0,.05);position:relative}
    .current-title{font-weight:700;color:#2c3e50;margin-bottom:10px}
    .waveform-container{margin-top:8px;border:1px solid #e1e4e8;border-radius:8px;padding:12px;background:#f9f9f9}
    #waveform{height:100px}
    .time-display{font-family:monospace;text-align:center;margin:8px 0;color:#666}

    /* 主控按钮：与简洁模式一致的圆形小按钮 */
    .round-row{display:flex;justify-content:center;gap:8px;margin-top:6px}
    .round-btn{background:#4a6fa5;color:#fff;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;border:none;cursor:pointer}
    .round-btn:hover{background:#2c3e50}

    /* 速度 & 复读 */
    .speed-control{display:flex;align-items:center;margin-top:12px;background:#f8f9fa;padding:8px;border-radius:8px;border:1px solid #e1e4e8;font-size:14px}
    .speed-control label{margin-right:10px;font-weight:600}
    .speed-control select{padding:6px;border-radius:4px;border:1px solid #ddd}
    .loop-section{margin-top:12px;background:#f0f7ff;padding:12px;border-radius:8px;border:1px dashed #4a6fa5}
    .loop-header{font-weight:700;margin-bottom:8px}
    .loop-times{display:flex;gap:10px;margin-top:8px}
    .loop-input{width:80px;padding:5px;border-radius:4px;border:1px solid #ddd}
    .region-loop{background:rgba(74,111,165,.2);position:absolute;top:0;height:100%;pointer-events:none}

    /* 清空按钮（仅图标） */
    .player-footer{margin-top:12px;display:flex;justify-content:flex-end}
    .icon-only{background:#e74c3c;color:#fff;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:none;cursor:pointer}
    .icon-only:hover{background:#c0392b}

    /* 简洁模式 */
    .lite-mode-container{position:fixed;inset:0;background:#f8f9fa;z-index:1000;display:none;justify-content:center;align-items:center}
    .lite-player{width:280px;max-width:92vw;padding:8px;border-radius:10px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .lite-toolbar{display:flex;justify-content:flex-end;gap:6px}
    .lite-toggle{background:#4a6fa5;color:#fff;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;border:none}
    .lite-speed select{font-size:11px;padding:2px 6px}
    .progress-container{width:100%;height:6px;background:#e1e4e8;border-radius:4px;margin:6px 0;overflow:hidden}
    .progress-bar{height:100%;width:0;background:#4a6fa5}
    .lite-controls{display:flex;justify-content:center;gap:6px}
    .lite-control-button{background:#4a6fa5;color:#fff;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:none}
    .lite-control-button:hover{background:#2c3e50}

    /* 拖放 */
    .drop-area{border:2px dashed #4a6fa5;border-radius:8px;padding:18px;text-align:center;background:#f0f7ff;margin-bottom:12px}
    .drop-area.drag-over{background:#e3f2fd;border-color:#2196f3;}
  </style>
</head>
<body>
  <div class="container">
    <h1>猫jio Player</h1>

    <div class="local-file-section">
      <div class="tip-box">使用浏览器 File API 直接播放本地文件（不上传）。关闭页面后支持自动/一键恢复。</div>
      <div id="message" class="message-box"></div>
      <div id="dropArea" class="drop-area">拖放音频文件到这里</div>

      <div class="controls">
        <input type="file" id="audioFiles" accept=".mp3,.wav,.ogg,.m4a,.flac" multiple>
        <button id="addFilesButton" class="add-button">添加文件</button>
        <button id="addByPickerButton" class="add-button small-button">系统文件选择器（可恢复）</button>
        <button id="restoreButton" class="add-button small-button">一键恢复上次列表</button>
        <button id="addFolderButton" class="add-button small-button">添加文件夹（尽量）</button>
        <button id="importZipButton" class="add-button small-button">导入 ZIP</button>
      </div>
    </div>

    <div class="player-section">
      <h2 style="margin:10px 0">我的音频库</h2>
      <!-- 单列表框（可聚焦以支持键盘） -->
      <div id="playlistBox" class="playlist-box" tabindex="0" aria-label="播放列表（↑↓选择，Enter播放）"></div>

      <div id="currentPlayer" class="current-player" style="display:none;">
        <div id="currentTitle" class="current-title">当前播放：</div>

        <div class="waveform-container">
          <div id="waveform"></div>
        </div>
        <div class="time-display"><span id="currentTime">00:00</span> / <span id="totalTime">00:00</span></div>

        <!-- 主控按钮：与简洁模式一致 -->
        <div class="round-row">
          <button id="fullPrevButton"   class="round-btn" title="上一首">⏮️</button>
          <button id="fullRewButton"    class="round-btn" title="后退5秒">⏪</button>
          <button id="fullPlayPauseButton" class="round-btn" title="播放/暂停">▶️</button>
          <button id="fullFwdButton"    class="round-btn" title="前进5秒">⏩</button>
          <button id="fullNextButton"   class="round-btn" title="下一首">⏭️</button>
        </div>

        <!-- 速度在复读前 -->
        <div class="speed-control">
          <label for="playbackSpeed">播放速度:</label>
          <select id="playbackSpeed">
            <option value="0.5">0.5x</option>
            <option value="0.75">0.75x</option>
            <option value="1" selected>1.0x (正常)</option>
            <option value="1.25">1.25x</option>
            <option value="1.5">1.5x</option>
            <option value="1.75">1.75x</option>
            <option value="2">2.0x</option>
          </select>
        </div>

        <!-- 选段复读 -->
        <div class="loop-section">
          <div class="loop-header">选段复读</div>
          <div class="controls" style="margin-top:0">
            <button id="setLoopStartBtn" class="small-button" style="background:#4a6fa5;color:#fff">设为开始</button>
            <button id="setLoopEndBtn" class="small-button" style="background:#4a6fa5;color:#fff">设为结束</button>
            <button id="startLoopBtn" class="small-button" style="background:#4a6fa5;color:#fff">开始复读</button>
            <button id="stopLoopBtn" class="small-button" style="background:#4a6fa5;color:#fff">停止复读</button>
          </div>
          <div style="margin-top:6px">
            <label for="loopCount">复读次数 (0=无限):</label>
            <input id="loopCount" type="number" min="0" value="3" class="loop-input">
          </div>
          <div class="loop-times">
            <div><label for="loopStart">开始(秒):</label><input id="loopStart" type="number" min="0" step="0.1" value="0" class="loop-input"></div>
            <div><label for="loopEnd">结束(秒):</label><input id="loopEnd" type="number" min="0" step="0.1" value="0" class="loop-input"></div>
          </div>
        </div>

        <!-- 底部：清空列表（垃圾桶图标） -->
        <div class="player-footer">
          <button id="clearPlaylistBtn" class="icon-only" title="清空列表">🗑️</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 简洁模式 -->
  <div id="liteModeContainer" class="lite-mode-container">
    <div class="lite-player">
      <div class="lite-toolbar">
        <button id="liteToggleBtn" class="lite-toggle" title="切换完整模式">🔄</button>
        <div class="lite-speed">
          <select id="litePlaybackSpeed">
            <option value="0.5">0.5x</option><option value="0.75">0.75x</option>
            <option value="1" selected>1x</option><option value="1.25">1.25x</option>
            <option value="1.5">1.5x</option><option value="1.75">1.75x</option>
            <option value="2">2x</option>
          </select>
        </div>
      </div>
      <div id="liteTitleDisplay" style="text-align:center;font-weight:600;margin:6px 0 2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">当前播放：</div>
      <div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>
      <div class="time-display"><span id="liteCurrentTime">00:00</span> / <span id="liteTotalTime">00:00</span></div>
      <div class="lite-controls">
        <button id="litePrevButton" class="lite-control-button">⏮️</button>
        <button id="liteRewindButton" class="lite-control-button">⏪</button>
        <button id="litePlayPauseButton" class="lite-control-button">▶️</button>
        <button id="liteForwardButton" class="lite-control-button">⏩</button>
        <button id="liteNextButton" class="lite-control-button">⏭️</button>
      </div>
    </div>
  </div>

  <script>
    let wavesurfer=null,isLooping=false,loopCounter=0,loopRegion=null;
    let audioFiles=[],currentAudioFile=null,currentAudio=null,updateTimer=null,isLiteMode=false;

    // 简易存储（同上版）
    const DB_NAME='catpaw-player', STORE='playlist';
    function idb(){return new Promise((res,rej)=>{const r=indexedDB.open(DB_NAME,1);r.onupgradeneeded=()=>r.result.createObjectStore(STORE);r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error);});}
    async function idbSet(key,val){const db=await idb();return new Promise((res,rej)=>{const tx=db.transaction(STORE,'readwrite');tx.objectStore(STORE).put(val,key);tx.oncomplete=()=>res();tx.onerror=()=>rej(tx.error);});}
    async function idbGet(key){const db=await idb();return new Promise((res,rej)=>{const tx=db.transaction(STORE,'readonly');const rq=tx.objectStore(STORE).get(key);rq.onsuccess=()=>res(rq.result);rq.onerror=()=>rej(rq.error);});}
    const hasFS='showOpenFilePicker' in window;

    function showMessage(t,type){const m=document.getElementById('message');m.textContent=t;m.className='message-box '+(type==='error'?'error-message':'success-message');}

    function isAudioExt(name){return ['.mp3','.wav','.ogg','.m4a','.flac','.aac'].some(ext=>name.toLowerCase().endsWith(ext));}

    // 排序（文件名自然顺序）
    function sortPlaylist(){ audioFiles.sort((a,b)=>a.name.localeCompare(b.name,undefined,{numeric:true,sensitivity:'base'})); }

    // —— 播放列表渲染 + 正在播放指示 + 键盘选中态 ——
    let selectedIndex = -1; // 键盘选择高亮
    function renderPlaylist(){
      const box=document.getElementById('playlistBox'); box.innerHTML='';
      if(!audioFiles.length){box.innerHTML='<div class="playlist-item" style="justify-content:center;color:#888">没有音频文件，请添加</div>';return;}
      audioFiles.forEach((f,i)=>{
        const li=document.createElement('div'); li.className='playlist-item'; li.dataset.index=i;
        // 指示点
        const dot=document.createElement('div'); dot.className='np';
        const span=document.createElement('span'); span.className='playlist-name'; span.textContent=f.name;
        li.appendChild(dot); li.appendChild(span);
        if(currentAudioFile && currentAudioFile.name===f.name) li.classList.add('active');
        if(i===selectedIndex) li.classList.add('selected');

        li.addEventListener('click',()=>playAudio(f,i));
        box.appendChild(li);
      });
    }
    function setSelected(i){
      if(!audioFiles.length) {selectedIndex=-1; return;}
      selectedIndex = Math.max(0, Math.min(audioFiles.length-1, i));
      renderPlaylist();
      // 尽量把选中项滚动进可视区
      const el=document.querySelector(`.playlist-item[data-index="${selectedIndex}"]`);
      if(el){ el.scrollIntoView({block:'nearest'}); }
    }

    // 键盘导航
    const playlistBox = document.getElementById('playlistBox');
    playlistBox.addEventListener('keydown', (e)=>{
      if(!audioFiles.length) return;
      if(e.key==='ArrowDown'){ setSelected((selectedIndex<0?0:selectedIndex+1)); e.preventDefault(); }
      else if(e.key==='ArrowUp'){ setSelected((selectedIndex<0?0:selectedIndex-1)); e.preventDefault(); }
      else if(e.key==='Home'){ setSelected(0); e.preventDefault(); }
      else if(e.key==='End'){ setSelected(audioFiles.length-1); e.preventDefault(); }
      else if(e.key==='Enter'){ if(selectedIndex>=0) playAudio(audioFiles[selectedIndex], selectedIndex); }
    });

    // —— 添加文件 / 拖放 ——
    document.getElementById('addFilesButton').addEventListener('click',()=>document.getElementById('audioFiles').click());
    document.getElementById('audioFiles').addEventListener('change',e=>{
      const files=Array.from(e.target.files).filter(f=>f.type.startsWith('audio/')||isAudioExt(f.name)).map(f=>({name:f.name,path:URL.createObjectURL(f),file:f}));
      audioFiles.push(...files); sortPlaylist(); renderPlaylist(); savePersistentPlaylist();
      if(selectedIndex<0 && audioFiles.length) setSelected(0);
      showMessage(`已添加 ${files.length} 个文件`,`success`);
      if(!currentAudioFile && audioFiles.length) playAudio(audioFiles[0],0);
      e.target.value='';
    });

    const drop=document.getElementById('dropArea');
    ['dragenter','dragover','dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();}));
    ['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,()=>drop.classList.add('drag-over')));
    ['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,()=>drop.classList.remove('drag-over')));
    drop.addEventListener('drop',e=>{
      const files=Array.from(e.dataTransfer.files).filter(f=>f.type.startsWith('audio/')||isAudioExt(f.name)).map(f=>({name:f.name,path:URL.createObjectURL(f),file:f}));
      audioFiles.push(...files); sortPlaylist(); renderPlaylist(); savePersistentPlaylist();
      if(selectedIndex<0 && audioFiles.length) setSelected(0);
      showMessage(`拖入 ${files.length} 个文件`,`success`);
      if(!currentAudioFile && audioFiles.length) playAudio(audioFiles[0],0);
    });

    // 其他添加方式（保留）
    const hasFS='showOpenFilePicker' in window;
    async function pickMultipleFiles(){
      if(hasFS){
        const handles=await window.showOpenFilePicker({multiple:true,types:[{description:'Audio',accept:{'audio/*':['.mp3','.m4a','.wav','.flac','.ogg','.aac']}}]});
        const files=[]; for(const h of handles){const f=await h.getFile(); files.push({name:f.name,path:URL.createObjectURL(f),file:f,handle:h});}
        return files;
      }else{ return new Promise(res=>{const i=document.createElement('input');i.type='file';i.multiple=true;i.accept='audio/*';i.onchange=()=>res(Array.from(i.files).map(f=>({name:f.name,path:URL.createObjectURL(f),file:f})));i.click();}); }
    }
    async function pickDirectoryFilesOrFallback(accept='audio/*'){
      const test=document.createElement('input'); if('webkitdirectory' in test){
        return new Promise(res=>{const i=document.createElement('input');i.type='file';i.multiple=true;i.accept=accept;i.webkitdirectory=true;i.onchange=()=>res(Array.from(i.files).map(f=>({name:f.name,path:URL.createObjectURL(f),file:f})));i.click();});
      } else { return await pickMultipleFiles(); }
    }
    async function importZipToPlaylist(zipFile){
      try{
        const buf=await zipFile.arrayBuffer(); const zip=await JSZip.loadAsync(buf); const entries=[];
        zip.forEach((p,e)=>{ if(!e.dir && isAudioExt(e.name)) entries.push(e); });
        if(!entries.length){ showMessage('ZIP 中未发现音频','error'); return; }
        const added=[];
        for(const e of entries){ const blob=await e.async('blob'); const name=e.name.split('/').pop(); added.push({name,path:URL.createObjectURL(blob),file:new File([blob],name,{type:blob.type})}); }
        audioFiles.push(...added); sortPlaylist(); renderPlaylist(); savePersistentPlaylist(); showMessage(`已从 ZIP 导入 ${added.length} 个文件`,'success');
        if(selectedIndex<0 && audioFiles.length) setSelected(0);
        if(!currentAudioFile) playAudio(audioFiles[0],0);
      }catch(e){console.error(e); showMessage('ZIP 导入失败','error');}
    }

    document.getElementById('addByPickerButton').addEventListener('click',async()=>{
      const files=await pickMultipleFiles(); if(!files.length) return;
      audioFiles.push(...files); sortPlaylist(); renderPlaylist(); savePersistentPlaylist(); showMessage(`添加 ${files.length} 个文件`,'success');
      if(selectedIndex<0 && audioFiles.length) setSelected(0);
      if(!currentAudioFile) playAudio(audioFiles[0],0);
    });
    document.getElementById('addFolderButton').addEventListener('click',async()=>{
      const files=await pickDirectoryFilesOrFallback('audio/*'); if(!files.length) return;
      audioFiles.push(...files); sortPlaylist(); renderPlaylist(); savePersistentPlaylist(); showMessage(`添加 ${files.length} 个文件`,'success');
      if(selectedIndex<0 && audioFiles.length) setSelected(0);
      if(!currentAudioFile) playAudio(audioFiles[0],0);
    });
    document.getElementById('importZipButton').addEventListener('click',()=>{
      const i=document.createElement('input'); i.type='file'; i.accept='.zip,application/zip'; i.onchange=()=>{ if(i.files[0]) importZipToPlaylist(i.files[0]); }; i.click();
    });

    // —— WaveSurfer ——
    function initWaveSurfer(){
      wavesurfer=WaveSurfer.create({container:'#waveform',waveColor:'#4a6fa5',progressColor:'#2c3e50',cursorColor:'#e74c3c',barWidth:2,barGap:1,height:100,normalize:true});
      wavesurfer.on('ready',()=>{
        document.getElementById('totalTime').textContent=formatTime(wavesurfer.getDuration());
        document.getElementById('loopEnd').value=wavesurfer.getDuration().toFixed(1);
      });
      wavesurfer.on('audioprocess',()=>{
        const t=wavesurfer.getCurrentTime(); document.getElementById('currentTime').textContent=formatTime(t);
        if(isLiteMode && currentAudio){ // 简洁模式进度条
          const pct=(currentAudio.currentTime/currentAudio.duration)*100 || 0;
          document.getElementById('progressBar').style.width=pct+'%';
          document.getElementById('liteCurrentTime').textContent=formatTime(currentAudio.currentTime||0);
        }
      });
    }
    initWaveSurfer();

    function formatTime(s){const m=Math.floor(s/60),ss=Math.floor(s%60);return `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;}

    function playAudio(file,index){
      const player=document.getElementById('currentPlayer'); player.style.display='block';
      currentAudioFile=file; currentAudioFile.index=index;
      document.getElementById('currentTitle').textContent='当前播放：'+file.name;
      document.getElementById('liteTitleDisplay').textContent=file.name;

      wavesurfer.load(file.path);
      // 更新列表高亮 & 键盘选中态
      selectedIndex = index;
      renderPlaylist();

      // 自动播放
      setTimeout(()=>{ if(!wavesurfer.isPlaying()) wavesurfer.play(); document.getElementById('fullPlayPauseButton').textContent='⏸️'; document.getElementById('litePlayPauseButton').textContent='⏸️'; }, 50);
    }

    // 主控按钮
    document.getElementById('fullPlayPauseButton').addEventListener('click',()=>{
      if(wavesurfer.isPlaying()){ wavesurfer.pause(); document.getElementById('fullPlayPauseButton').textContent='▶️'; document.getElementById('litePlayPauseButton').textContent='▶️'; }
      else { wavesurfer.play();  document.getElementById('fullPlayPauseButton').textContent='⏸️'; document.getElementById('litePlayPauseButton').textContent='⏸️'; }
    });
    document.getElementById('fullRewButton').addEventListener('click',()=>{ const t=wavesurfer.getCurrentTime(); wavesurfer.seekTo(Math.max(0,t-5)/wavesurfer.getDuration()); });
    document.getElementById('fullFwdButton').addEventListener('click',()=>{ const t=wavesurfer.getCurrentTime(); wavesurfer.seekTo(Math.min(wavesurfer.getDuration(),t+5)/wavesurfer.getDuration()); });

    function navTrack(step){
      if(!audioFiles.length||currentAudioFile==null) return;
      sortPlaylist();
      let i=currentAudioFile.index ?? audioFiles.findIndex(f=>f.name===currentAudioFile.name);
      if(i<0) i=0;
      let n=i+step; if(n<0) n=audioFiles.length-1; if(n>=audioFiles.length) n=0;
      playAudio(audioFiles[n],n);
    }
    document.getElementById('fullPrevButton').addEventListener('click',()=>navTrack(-1));
    document.getElementById('fullNextButton').addEventListener('click',()=>navTrack(1));

    // 速度同步
    document.getElementById('playbackSpeed').addEventListener('change',function(){ const s=parseFloat(this.value); wavesurfer.setPlaybackRate(s); document.getElementById('litePlaybackSpeed').value=this.value; });
    document.getElementById('litePlaybackSpeed').addEventListener('change',function(){ const s=parseFloat(this.value); wavesurfer.setPlaybackRate(s); document.getElementById('playbackSpeed').value=this.value; });

    // 简洁模式与完整模式切换（保留原逻辑）
    const lite=document.getElementById('liteModeContainer');
    document.getElementById('liteToggleBtn').addEventListener('click',()=>{ lite.style.display='none'; });
    document.getElementById('litePlayPauseButton').addEventListener('click',()=>document.getElementById('fullPlayPauseButton').click());
    document.getElementById('liteRewindButton').addEventListener('click',()=>document.getElementById('fullRewButton').click());
    document.getElementById('liteForwardButton').addEventListener('click',()=>document.getElementById('fullFwdButton').click());
    document.getElementById('litePrevButton').addEventListener('click',()=>navTrack(-1));
    document.getElementById('liteNextButton').addEventListener('click',()=>navTrack(1));

    // 清空列表
    document.getElementById('clearPlaylistBtn').addEventListener('click',()=>{
      if(!audioFiles.length) return;
      if(confirm('确定清空播放列表吗？')){
        audioFiles.forEach(f=>{try{URL.revokeObjectURL(f.path);}catch(_){}});
        audioFiles=[]; renderPlaylist();
        document.getElementById('currentPlayer').style.display='none';
        currentAudioFile=null; selectedIndex=-1;
        localStorage.removeItem('audioPlaylistManifest'); idbSet('handles',null);
        showMessage('已清空列表','success');
      }
    });

    // 自动恢复（清单/句柄）
    (async function autoRestore(){
      try{
        const saved=await idbGet('handles');
        if(hasFS && saved && saved.length){
          const rebuilt=[];
          for(const it of saved){ const h=it.handle; if(h && (await h.queryPermission?.({mode:'read'}))!=='granted'){ const r=await h.requestPermission?.({mode:'read'}); if(r!=='granted') throw 0; } const f=await h.getFile(); rebuilt.push({name:f.name,path:URL.createObjectURL(f),file:f,handle:h}); }
          if(rebuilt.length){ audioFiles=rebuilt; sortPlaylist(); renderPlaylist(); setSelected(0); showMessage('已自动恢复上次播放列表 ✅','success'); return; }
        }
        const manifest=localStorage.getItem('audioPlaylistManifest'); if(manifest){ showMessage('找到上次清单，可用“一键恢复上次列表”进行匹配','success'); }
      }catch(e){}
    })();

    // 一键恢复
    document.getElementById('restoreButton').addEventListener('click',async()=>{
      try{
        const manifestStr=localStorage.getItem('audioPlaylistManifest'); if(!manifestStr){showMessage('没有可恢复的清单','error');return;}
        const manifest=JSON.parse(manifestStr); const picked=await pickDirectoryFilesOrFallback('audio/*');
        const map=new Map(picked.map(p=>[(p.name+'::'+(p.file?.size||0)),p]));
        const matched=[]; for(const m of manifest){ const key=m.name+'::'+(m.size||0); matched.push(map.get(key)||picked.find(p=>p.name===m.name)); }
        const final=matched.filter(Boolean); if(!final.length){showMessage('未匹配到文件','error');return;}
        audioFiles=final; sortPlaylist(); renderPlaylist(); setSelected(0); showMessage(`已恢复 ${final.length} 个文件 ✅`,'success'); playAudio(audioFiles[0],0);
      }catch(e){console.error(e); showMessage('恢复失败','error');}
    });

    // 初始渲染
    renderPlaylist();
  </script>
</body>
</html>
